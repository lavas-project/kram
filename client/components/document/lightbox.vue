<template>
    <transition name="light-box" v-if="isReady">
        <div class="light-box" v-show="show" @click.prevent.stop="close">
            <div class="img-wrapper">
                <img :src="src"
                    :style="{width: widthStr, height: heightStr}"
                >
            </div>
            <div class="mask"></div>
        </div>
    </transition>
</template>

<style lang="stylus" scoped>
    @require '~@/assets/style/variable'
    .light-box
        fixed 0 0 0 0
        z-index 130
        .mask
            width 100%
            height 100%
            z-index 1
            opacity .7
            background $colorBlack
        .img-wrapper
            absolute 50% _ _ 50%
            transform translate(-50%, -50%)
            z-index 2
            overflow auto
            max-width 90%
            max-height 90%
            // cursor zoom-out
            // img
            //     size 100% 100%
    .light-box-enter-active,
    .light-box-leave-active
        transition opacity .3s

    .light-box-enter,
    .light-box-leave-active
        opacity 0
</style>

<script>
    import {imageLoader} from '@/assets/common/utils/basic';
    export default {
        name: 'light-box',
        props: ['selector'],
        data() {
            return {
                isReady: false,
                container: null,
                event: async e => {
                    if (e.target.tagName !== 'IMG') {
                        return;
                    }

                    let {status, data} = await imageLoader(e.target.src);
                    if (status === 0) {
                        this.width = data.width;
                        this.height = data.height;

                        this.src = e.target.src;
                        this.showImage = true;
                    }
                    else {
                        console.log('wtf');
                    }
                },
                width: 0,
                height: 0,
                src: '',
                clientWidth: 0,
                clientHeight: 0,
                showImage: false,
                showError: false
            };
        },
        watch: {
            selector() {
                this.bind();
            }
        },
        computed: {
            show() {
                return this.showImage || this.showError;
            },
            widthStr() {
                return this.width + 'px';
            },
            heightStr() {
                return this.height + 'px';
            }
        },
        methods: {
            close() {
                this.showImage = false;
                this.showError = false;
            },
            bind() {
                if (typeof this.selector === 'string') {
                    this.container = document.querySelector(this.selector);
                }
                else {
                    this.container = this.selector;
                }

                this.container && this.container.removeEventListener('click', this.event);
                this.container && this.container.addEventListener('click', this.event);
            }
        },
        mounted() {
            this.isReady = true;
            this.clientWidth = document.documentElement.clientWidth;
            this.clientHeight = document.documentElement.clientHeight;
            this.bind();
        },
        beforeDestroy() {
            this.container && this.container.removeEventListener('click', this.event);
        }
    };
</script>